<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Money Tracker – Purse & Savings</title>
  <style>
    body {
      background: #eaf1fa;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px #0002;
      padding: 24px;
    }
    header { text-align: center; margin-bottom: 18px; }

    .sidebar-toggle {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 10px 0 24px 0;
    }
    .sidebar-toggle button {
      padding: 9px 24px;
      border-radius: 20px;
      border: none;
      background: #ddd;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-toggle .active {
      background: #3266c8;
      color: white;
      font-weight: bold;
    }
    .summary-cards {
      display: flex; gap: 16px; margin-bottom: 26px;
      flex-wrap: wrap; justify-content: center;
    }
    .card {
      flex: 1;
      min-width: 190px;
      background: #f9fafb;
      border-radius: 7px;
      box-shadow: 0 2px 6px #0001;
      text-align: center;
      padding: 12px 8px;
      margin: 0 2px;
    }
    .card h3 { font-size: 1em; margin: 0 0 5px 0;}
    .amount { font-size: 1.4em; font-weight: bold;}
    .form-section {background: #f6f6ff; border-radius: 8px; padding: 16px; margin-bottom: 22px;}
    .form-row {display:flex; flex-wrap:wrap; gap:12px;}
    .form-group { flex: 1; display: flex; flex-direction: column;}
    label { font-weight: 500; margin-bottom: 3px;}
    input, select {padding: 7px 9px; border-radius: 4px; border: 1px solid #d3dbe5;}
    .actions-row {display:flex; gap:12px; align-items:center; margin-top: 10px;}
    .btn {padding: 7px 19px; border-radius: 5px; border:none; cursor:pointer;}
    .btn-primary {background:#3266c8;color:#fff;}
    .btn-success {background:#37b97a; color:#fff;}
    .btn-danger {background:#ed1142;color:#fff;}
    .btn:disabled { opacity: .7; }
    table { width:100%; border-collapse:collapse; margin: 14px 0;}
    th, td {padding:7px 8px; border-bottom: 1px solid #e6e9f0;}
    th {background:#f4f7fb;}
    .type-in {color:#37b97a;}
    .type-out {color:#ed1142;}
    .type-transfer {color:#c88c32;}
    .month-section { margin-bottom: 36px; border:1px solid #d0d8e6; border-radius:8px;}
    .month-header {background:#3266c8;color:#fff; padding:7px 18px; font-weight:600; border-radius:8px 8px 0 0;}
    .month-summary {background:#f9fafe; padding:7px 12px; display:flex; gap:18px; border-top:1px solid #eaeaea;}
    .export-row {margin:18px 0;}
    footer {text-align:center;color:#999; font-size:.88em; margin-top:35px;}
    @media (max-width: 600px) {
      .container {padding:5px;}
      .summary-cards {flex-direction:column;}
      .form-row {flex-direction:column;}
      .month-summary {flex-direction:column;}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Money Tracker</h1>
    <span>Purse & Savings · Monthly Reset · ZIP Export</span>
  </header>
  <div class="sidebar-toggle">
    <button id="togglePurse" class="active">Purse</button>
    <button id="toggleSavings">Savings</button>
  </div>

  <div class="summary-cards">
    <div class="card balance">
      <h3>Current Balance</h3>
      <div class="amount" id="current-balance">Rp 0</div>
    </div>
    <div class="card income">
      <h3>Total Income</h3>
      <div class="amount" id="total-income">Rp 0</div>
    </div>
    <div class="card expense">
      <h3>Total Expenses</h3>
      <div class="amount" id="total-expenses">Rp 0</div>
    </div>
  </div>

  <div class="form-section">
    <h2>Add Transaction</h2>
    <form id="transaction-form">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="date" required />
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="time" id="time" required />
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="description" placeholder="optional"/>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="type" required>
            <option value="">Choose type</option>
            <option value="In">Income (In)</option>
            <option value="Out">Expense (Out)</option>
            <option value="Transfer">Withdraw/Transfer (Savings→Purse)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount (IDR)</label>
          <input type="number" id="cost" placeholder="e.g. 10000" min="0" step="100" required />
        </div>
      </div>
      <div class="actions-row">
        <button type="submit" class="btn btn-primary">Add Transaction</button>
        <button type="button" class="btn btn-success" id="export-btn">Export to ZIP</button>
        <input type="file" id="import-file" style="display:none" />
        <button type="button" class="btn btn-danger" id="clear-btn">Clear All Data</button>
      </div>
      <div style="margin-top:2px; font-size:0.93em; color:#888;">
        Withdraw/Transfer logs outgoing in Savings and incoming in Purse.
      </div>
    </form>
  </div>

  <div>
    <h2>Transaction History (<span id="current-account-label">Purse</span>)</h2>
    <div id="transaction-list"></div>
  </div>
  <div class="export-row" id="export-status"></div>
  <footer>Powered by your GitHub repo · All transactions are monthly reset, summaries preserved.</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let transactions = [];
let currentAccount = "Purse"; // Default
let monthFormat = { month: 'long', year: 'numeric' };

// --- Utility Functions ---
function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {style:'currency',currency:'IDR',minimumFractionDigits:0}).format(amount);
}
function getMonthKey(date) {
  let d = new Date(date);
  return d.toLocaleString('en-US', monthFormat);
}
function todayLocalISO() {
  let now = new Date(), o=now.getTimezoneOffset()*60000;
  return (new Date(now-o)).toISOString().slice(0,10);
}

// --- Transaction Data Storage Logic ---
// For the demo: Use localStorage. In production, sync with your backend repo when authenticated.
function saveTransactions() {
  localStorage.setItem('moneyTrackerTransactions', JSON.stringify(transactions));
}
function loadTransactions() {
  let data = localStorage.getItem('moneyTrackerTransactions');
  if (!data) { transactions=[]; saveTransactions(); }
  else transactions = JSON.parse(data);
  if (!Array.isArray(transactions)) transactions=[];
}

// --- UI Elements ---
const transactionForm = document.getElementById('transaction-form');
const currentBalanceEl = document.getElementById('current-balance');
const totalIncomeEl = document.getElementById('total-income');
const totalExpensesEl = document.getElementById('total-expenses');
const transactionList = document.getElementById('transaction-list');
const togglePurseBtn = document.getElementById('togglePurse');
const toggleSavingsBtn = document.getElementById('toggleSavings');
const currentAccountLabel = document.getElementById('current-account-label');
const exportBtn = document.getElementById('export-btn');
const clearBtn = document.getElementById('clear-btn');
const exportStatus = document.getElementById('export-status');

togglePurseBtn.onclick = () => switchAccount('Purse');
toggleSavingsBtn.onclick = () => switchAccount('Savings');

function switchAccount(acc) {
  currentAccount = acc;
  togglePurseBtn.classList.toggle('active', acc === 'Purse');
  toggleSavingsBtn.classList.toggle('active', acc === 'Savings');
  currentAccountLabel.textContent = acc;
  renderSummary();
  renderTransactions();
}

// --- Monthly Reset ---
function monthlyReset() {
  let now = new Date();
  let firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  let lastCheck = localStorage.getItem("monthlyResetDate");
  let needReset = !lastCheck || (new Date(lastCheck).getTime() < firstOfMonth.getTime());
  if (needReset) {
    localStorage.setItem("monthlyResetDate", firstOfMonth.toISOString());
    // Do NOT delete transactions! Just display summary.
  }
}

// --- Render Functions ---
function renderSummary() {
  let month = getMonthKey(todayLocalISO());
  let filtered = transactions.filter(t =>
    getMonthKey(t.date) === month && t.account === currentAccount
  );
  let income = filtered.filter(t => t.type === "In" || (t.type === "Transfer" && currentAccount === "Purse"))
    .reduce((a,c)=>a+parseFloat(c.cost||0),0);
  let out = filtered.filter(t => t.type === "Out" || (t.type === "Transfer" && currentAccount === "Savings"))
    .reduce((a,c)=>a+parseFloat(c.cost||0),0);
  currentBalanceEl.textContent = formatCurrency(income-out);
  totalIncomeEl.textContent = formatCurrency(income);
  totalExpensesEl.textContent = formatCurrency(out);
}

function renderTransactions() {
  let months = {};
  for (let t of transactions) {
    if (t.account !== currentAccount) continue;
    let k = getMonthKey(t.date);
    if (!months[k]) months[k]=[];
    months[k].push(t);
  }
  // Sort months descending
  let sortedMonths = Object.keys(months).sort((a,b)=>new Date(b)-new Date(a));
  let html = '';
  for (let month of sortedMonths) {
    let trs = months[month];
    let minTypes = t => t.type === "In" || (t.type === "Transfer" && currentAccount === "Purse");
    let moutTypes = t => t.type === "Out" || (t.type === "Transfer" && currentAccount === "Savings");
    let mincome = trs.filter(minTypes).reduce((a,c)=>a+parseFloat(c.cost||0),0);
    let mout = trs.filter(moutTypes).reduce((a,c)=>a+parseFloat(c.cost||0),0);
    let mbal = mincome-mout;
    html += `<div class="month-section">
      <div class="month-header">${month}</div>
      <table><thead>
      <tr><th>Date</th><th>Time</th><th>Description</th><th>Type</th><th>Amount</th><th>Actions</th></tr>
      </thead><tbody>`;
    for (let i=0; i<trs.length; ++i) {
      let t=trs[i], ix=transactions.indexOf(t);
      html += `<tr>
        <td>${t.date}</td><td>${t.time}</td>
        <td>${t.description||''}</td>
        <td class="${t.type==='In'?'type-in':t.type==='Out'?'type-out':'type-transfer'}">${t.type}</td>
        <td>${formatCurrency(parseFloat(t.cost)||0)}</td>
        <td><button class="btn btn-danger" style="padding:2px 10px;font-size:.9em;" onclick="deleteTransaction(${ix})">Delete</button></td>
      </tr>`;
    }
    html += `</tbody></table>
      <div class="month-summary">
        <span>Income: ${formatCurrency(mincome)}</span>
        <span>Expenses: ${formatCurrency(mout)}</span>
        <span>Balance: ${formatCurrency(mbal)}</span>
      </div>
    </div>`;
  }
  if (!html) html = '<div style="text-align:center; color:#bbb; margin:30px 0;">No transactions yet.</div>';
  transactionList.innerHTML = html;
}
window.deleteTransaction = function(ix) {
  if (confirm("Delete?")) {
    transactions.splice(ix,1);
    saveTransactions();
    renderSummary();
    renderTransactions();
  }
};

// --- Add Transaction ---
transactionForm.onsubmit = function(e) {
  e.preventDefault();
  let date = document.getElementById("date").value;
  let time = document.getElementById("time").value;
  let description = document.getElementById("description").value;
  let type = document.getElementById("type").value;
  let cost = document.getElementById("cost").value;
  if (!date || !time || !type || !cost) return;
  
  if (type === "Transfer" && currentAccount === "Savings") {
    // Savings → Purse transfer (Save 2 transactions!)
    transactions.push({
      date, time, description: description||"Transfer to Purse",
      type: "Transfer", cost, account: "Savings"
    });
    transactions.push({
      date, time, description: description||"Received from Savings",
      type: "Transfer", cost, account: "Purse"
    });
  } else {
    transactions.push({
      date, time, description,
      type, cost, account: currentAccount
    });
  }
  saveTransactions();
  renderSummary();
  renderTransactions();
  transactionForm.reset();
  document.getElementById("date").value = todayLocalISO();
  document.getElementById("time").value = (new Date()).toTimeString().slice(0,5);
}
// --- On Export: ZIP w/ CSV for each account ---
exportBtn.onclick = function() {
  exportBtn.disabled = true;
  exportStatus.textContent = "...preparing export...";
  setTimeout(exportToZip, 120);
};
function exportToZip() {
  let zip = new JSZip();
  for (let acc of ["Purse","Savings"]) {
    let filtered = transactions.filter(t => t.account === acc);
    let months = {};
    for (let t of filtered) {
      let k = getMonthKey(t.date);
      if (!months[k]) months[k]=[];
      months[k].push(t);
    }
    let csv='Date,Time,Description,Type,Amount\n';
    for (let month of Object.keys(months).sort()) {
      csv += `\n${month} Summary:\n`;
      let trs=months[month];
      for (let t of trs)
        csv += `"${t.date}","${t.time}","${t.description||''}","${t.type}",${t.cost}\n`;
      let minTypes = t=>t.type==="In"||(t.type==="Transfer"&&acc==="Purse");
      let moutTypes = t=>t.type==="Out"||(t.type==="Transfer"&&acc==="Savings");
      let mincome = trs.filter(minTypes).reduce((a,c)=>a+parseFloat(c.cost||0),0);
      let mout = trs.filter(moutTypes).reduce((a,c)=>a+parseFloat(c.cost||0),0);
      let mbal = mincome-mout;
      csv += `,,,"Month Income",${mincome}\n`;
      csv += `,,,"Month Expenses",${mout}\n`;
      csv += `,,,"Month Balance",${mbal}\n`;
    }
    zip.file(acc.toLowerCase()+'.csv',csv);
  }
  zip.generateAsync({type:'blob'}).then(function(content){
    let a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'money_tracker_export.zip';
    a.click();
    exportStatus.textContent = "ZIP file downloaded!";
    exportBtn.disabled = false;
  });
}

// --- Clear All Data (prompt) ---
clearBtn.onclick = function() {
  if (confirm('Are you sure? This deletes all transactions.')) {
    transactions=[];
    saveTransactions();
    renderSummary();
    renderTransactions();
  }
}

// --- Initial Setup ---
document.getElementById("date").value = todayLocalISO();
document.getElementById("time").value = (new Date()).toTimeString().slice(0,5);
monthlyReset();
loadTransactions();
switchAccount('Purse'); // Default

</script>
</body>
</html>
